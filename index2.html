<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitchess</title>
    
    <!-- CSS : Chessboard.js officiel -->
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU" crossorigin="anonymous">
    
    <!-- CSS : Notre système modulaire -->
    <link rel="stylesheet" href="css2/main.css">
    
    <!-- Fonts et icônes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href='https://fonts.googleapis.com/css?family=Roboto+Condensed' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
    <base href="./">
</head>

<body data-team="w">
    <!-- Header principal -->
    <header class="main-header">
        <h1 data-lang="fr-FR">Twitchess</h1>
        <!-- Statuts du jeu -->
        <h5 id="gameTitle"></h5>
        <h3 data-lang="fr-FR" data-team="w">Trait aux blancs</h3>
        <h3 data-lang="fr-FR" data-team="b">Trait aux noirs</h3>
        <h4 data-lang="en-EN" class="status"></h4>
        <!-- Pièces disponibles -->
        <div class="sidebar-section">
            <h3 class="sidebar-section-title">Coups disponibles</h3>
            <div class="available-pieces">
                <ul id="availableList">
                    <ul id="availableListP"></ul>
                    <ul id="availableListB"></ul>
                    <ul id="availableListN"></ul>
                    <ul id="availableListR"></ul>
                    <ul id="availableListQ"></ul>
                    <ul id="availableListK"></ul>
                </ul>
            </div>
        </div>
    </header>

    <!-- Layout principal -->
    <main class="main-content">
        <!-- Section échiquier -->
        <section class="board-section">
            <div id="board_wrapper">
                <canvas id="primary_canvas" width="630" height="630"></canvas>
                <canvas id="drawing_canvas" width="630" height="630"></canvas>
                <div id="myBoard" style="width: 630px;"></div>
            </div>

                            <div class="votes">                    
                    <!-- Liste des votes -->
                    <ol class="prefixed styled"></ol>
                    
                    <!-- Graphique des votes -->
                    <div class="chart-container">
                        <canvas id="chartPoll" width="600" height="150"></canvas>
                    </div>
                    
                    <!-- Graphique D3 alternatif -->
                    <div id="chart"></div>
                </div>
        </section>

        <!-- Sidebar avec informations -->
        <aside class="sidebar game-info">
            <!-- Historique des coups -->
            <div class="sidebar-section">
                <h3 class="sidebar-section-title">Historique</h3>
                <div class="poll prefixed styled">
                    <ol></ol>
                </div>
            </div>
        </aside>
    </main>

    <!-- Section problèmes d'échecs -->
    <section id="probleminfo" class="problem-section">
        <div class="problem-details">
            <div class="problem-meta">
                <span>Ouverture : </span>
                <span data-opening=""></span>
            </div>
            <div class="problem-stats">
                <span data-attempt="">0</span> / <span data-length="">0</span>
                <span data-omgSolution="" style="display: none;"></span>
                <span data-fen="" style="display: none;"></span>
            </div>
        </div>
    </section>

    <!-- Timer affiché -->
    <div id="timer-display" class="timer-display">
            <div class="countdown">
        <svg viewBox="0 0 100 100">
            <circle r="45" cx="50" cy="50" fill="transparent" stroke="#333" stroke-width="3"/>
            <circle r="45" cx="50" cy="50" fill="transparent" stroke="#667eea" stroke-width="3"
                    stroke-dasharray="283" stroke-dashoffset="0"
                    stroke-linecap="round" transform="rotate(-90 50 50)"/>
                    <span id="timer-value">00:00</span>
        </svg>
    </div>
        
    </div>

    <!-- Timer circulaire classique (existant, gardé pour compatibilité) -->


    <!-- Modal de configuration -->
    <div id="configModal" class="modal">
        <div class="modal-content">
        <form id="configForm">
            <span class="close">&times;</span>
            <h2>Configuration</h2>
            <fieldset class="twitch">
                <legend>Connexion avec la chaine Twitch</legend>
                <label for="defaultChannel">Enter twitch channel&nbsp;</label>
                <input type="text" id="defaultChannel" name="defaultChannel" >
            </fieldset>
            <fieldset class="gameMode">
                <legend>Mode de jeu</legend>            
                <input type="radio" id="yoloMode" name="gameMode" value="normal">
                <label for="yoloMode">Jouer en mode YOLO (sandbox)</label>
                <br>
                <input type="radio" id="probMode" name="gameMode" value="probMode">
                <label for="probMode">Jouer en mode problèmes (ok but fix vote/reload issues)</label>
                <div data-game-mode="probMode">
                    <fieldset class="theme-filter-section">
                            <legend>Filtrage par thèmes</legend>
                            
                            <div class="filter-controls">
                                <button type="button" class="btn btn-secondary" onclick="selectAllThemes()">
                                    Tout sélectionner
                                </button>
                                <button type="button" class="btn btn-danger" onclick="clearThemeFilter()">
                                    Effacer la sélection
                                </button>
                            </div>
                            
                            <div class="problem-count" id="problemCount">
                                <span id="availableProblems">-</span>
                            </div>
                            
                            <div class="theme-list" id="themeList">
                                <!-- Les thèmes seront générés dynamiquement -->
                            </div>
                            
                            <div class="selected-themes" id="selectedThemes" style="display: none;">
                                <div id="selectedThemesTags"></div>
                            </div>
                            </fieldset>
                        </div>
                <br>
                <input type="radio" id="mod1vViewers" name="gameMode" value="mod1vViewers">
                    <label for="mod1vViewers">Seul contre tous (wip)</label>
                <div data-game-mode="mod1vViewers">
                    <label for="mod1vViewersPlayer">Pseudo du joueur&nbsp;</label>
                    <input type="text" id="mod1vViewersPlayer" name="mod1vViewersPlayer" >
                    </div>
                    <br>
                <input type="radio" id="mod1v1" name="gameMode" value="mod1v1">
                    <label for="mod1v1">Un contre un (ok?)</label>
                <div data-game-mode="mod1v1">
                    <label for="oneVsOneModeList0">Pseudo du Joueur1&nbsp;</label><input type="text" id="oneVsOneModeList0" name="oneVsOneModeList0">
                    <br>
                    <label for="oneVsOneModeList1">Pseudo du Joueur2&nbsp;</label><input type="text" id="oneVsOneModeList1" name="oneVsOneModeList1">
                </div>
                <br>
                <input type="radio" id="modStreamerChatvStreamerChat" name="gameMode" value="modStreamerChatvStreamerChat">
                <label for="modStreamerChatvStreamerChat">Chat contre Chat (ok?)</label>
                <div data-game-mode="modStreamerChatvStreamerChat" class="multiplayer-setup">
                    <div class="multiplayer-tabs">
                        <div class="multiplayer-tab create active" data-tab="create">
                            <i class="fas fa-crown"></i>
                            <h3>Créer une partie</h3>
                            <p>Hébergez et invitez un autre streameur</p>
                        </div>
                        <div class="multiplayer-tab join" data-tab="join">
                            <i class="fas fa-sign-in-alt"></i>
                            <h3>Rejoindre une partie</h3>
                            <p>Connectez-vous avec un code</p>
                        </div>
                    </div>
                    
                    <!-- Contenu -->
                    <div class="multiplayer-content">
                        <!-- Panneau Créer -->
                        <div id="create-panel" class="multiplayer-panel active">
                            <div class="form-group">
                                <label for="hostStreamerName">
                                    <i class="fab fa-twitch"></i> Votre nom de streameur
                                </label>
                                <input type="text" id="hostStreamerName" name="streamerChatvStreamerChat0" class="form-control" placeholder="VotreNomTwitch">
                            </div>
                            
                            <button type="button" class="btn btn-primary" id="createGameBtn">
                                <i class="fas fa-plus"></i> Créer la partie
                            </button>
                            
                            <!-- Panneau de partie créée -->
                            <div id="gameCreatedInfo" class="game-created" style="display: none;">
                                <h4>✅ Partie créée !</h4>
                                
                                <div style="margin: 15px 0;">
                                    <span>Code de partie :</span>
                                    <div class="game-code" id="gameCode">XXXX</div>
                                </div>
                                
                                <div style="margin: 15px 0;">
                                    <span>Statut :</span>
                                    <span class="status status-waiting" id="gameStatus">En attente...</span>
                                </div>
                                
                                <div class="url-section">
                                    <label>Votre URL (Blancs) :</label>
                                    <div class="url-box">
                                        <span id="hostUrl">-</span>
                                        <button class="btn-copy" data-target="hostUrl">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="url-section">
                                    <label>URL pour l'adversaire (Noirs) :</label>
                                    <div class="url-box">
                                        <span id="guestUrl">-</span>
                                        <button class="btn-copy" data-target="guestUrl">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Panneau Rejoindre -->
                        <div id="join-panel" class="multiplayer-panel">
                            <div class="form-group">
                                <label for="guestStreamerName">
                                    <i class="fab fa-twitch"></i> Votre nom de streameur
                                </label>
                                <input type="text" id="guestStreamerName" name="streamerChatvStreamerChat1" class="form-control" placeholder="VotreNomTwitch">
                            </div>
                            
                            <div class="form-group">
                                <label for="gameCodeInput">
                                    <i class="fas fa-key"></i> Code de la partie
                                </label>
                                <input type="text" id="gameCodeInput" class="form-control game-code-input" placeholder="XXXX" maxlength="4">
                            </div>
                            
                            <button type="button" class="btn btn-primary" id="joinGameBtn">
                                <i class="fas fa-sign-in-alt"></i> Rejoindre
                            </button>
                            
                            <!-- Panneau de partie rejointe -->
                            <div id="gameJoinedInfo" class="game-joined" style="display: none;">
                                <h4>✅ Connecté !</h4>
                                
                                <div style="margin: 15px 0;">
                                    <span>Statut :</span>
                                    <span class="status status-connected">Prêt</span>
                                </div>
                                
                                <div class="url-section">
                                    <label>Votre URL (Noirs) :</label>
                                    <div class="url-box">
                                        <span id="playerUrl">-</span>
                                        <button class="btn-copy" data-target="playerUrl">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <input type="radio" id="modViewersvViewers" name="gameMode" value="modViewersvViewers">
                <label for="modViewersvViewers">Tous contre tous (id pair/impair)(ok but cringe)</label>
            </fieldset>

            <fieldset>
            <legend>Mode Vote !</legend> 
            <input type="checkbox" data-mode="timerMode" id="timerMode" name="timerMode">
            <label for="timerMode">Activer le mode vote</label>
            <div data-time-mode>
                <label for="InitialvoterTimer">Temps d'un tour</label>
                <input type="number" id="InitialvoterTimer" name="InitialvoterTimer" min="0"> s
                <br>                
                <label for="timerWheelAnimation">Animation de la roue </label>
                <input type="number" id="timerWheelAnimation" name="timerWheelAnimation" min="0"> s
                <br>
                <input type="checkbox" id="limitToOneVote" name="limitToOneVote">
                <label for="limitToOneVote">Vote unique</label>
                <br>
                <input type="checkbox" id="majorityMode" name="majorityMode">               
                <label for="majorityMode">Majorité ? / (sinon tirage au sort)</label>
            </div>
        </fieldset>         
            <fieldset>
                <legend>Options de timer</legend> 
                <label for="pauseAfterWinLose">Durée de la pause (entre les parties/problèmes)</label>
                <input type="number" id="pauseAfterWinLose" name="pauseAfterWinLose" min="0"> s
        </fieldset>
                <fieldset>
                    <legend>Restrictions d'accès</legend>
                    <input type="checkbox" id="followMode" name="followMode">
                    <label for="followMode">Mode followers uniquement</label>
                    <br>
                    <input type="checkbox" id="subMode" name="subMode">
                    <label for="subMode">Mode abonnés uniquement</label>
                    <br>
                    <small style="color: #aaa; font-size: 12px;">
                        Note: Les modérateurs, VIPs et le broadcaster peuvent toujours jouer
                    </small>
                </fieldset>
            <fieldset>
                <legend>Autres options</legend> 
            <input type="checkbox" id="noBg" name="noBg">
            <label for="noBg">Supprimer le background (test sur OBS ?)</label>
        </fieldset>

        <button type="submit" class="form-btn">Sauvegarde + reload<i class="fas fa-save"></i></button>
    </form>
        </div>
    </div>

    <!-- Bouton d'ouverture de la configuration -->
    <button id="openFormButton" class="config-button">
        <i class="fas fa-cog"></i>
    </button>

    <!-- Scripts JavaScript -->
    
    <!-- Configuration globale -->
    <script>
        // Configuration pour la production
        window.CHESS_VOTER_CONFIG = {
            basePath: '/chessTwitchVoter/',
            serverUrl: null, // Mettez l'URL de votre serveur si vous en avez un
            isProduction: window.location.hostname !== 'localhost'
        };
        
        // Variables globales pour le multiplayer
        window.multiplayerMode = false;
        window.gameSocket = null;
        window.currentGameId = null;
        window.playerColor = null;
    </script>

<script>
// JavaScript pour gérer l'interface multiplayer
document.addEventListener('DOMContentLoaded', function() {
    // Gestion des onglets
    document.querySelectorAll('.multiplayer-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabName = this.dataset.tab;
            
            // Activer l'onglet
            document.querySelectorAll('.multiplayer-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // Afficher le panneau correspondant
            document.querySelectorAll('.multiplayer-panel').forEach(panel => panel.classList.remove('active'));
            document.getElementById(tabName + '-panel').classList.add('active');
        });
    });
    
    // Bouton créer partie
    document.getElementById('createGameBtn')?.addEventListener('click', function(e) {
        e.preventDefault(); // Empêcher le submit du formulaire
        
        const streamerName = document.getElementById('hostStreamerName').value;
        if (!streamerName) {
            alert('Veuillez entrer votre nom de streameur');
            return;
        }
        
        // Simuler la création de partie
        const gameCode = Math.random().toString(36).substring(2, 6).toUpperCase();
        document.getElementById('gameCode').textContent = gameCode;
        
        // Générer les URLs
        const baseUrl = window.location.origin + window.location.pathname;
        const hostUrl = `${baseUrl}?game=${gameCode}&role=host&streamer=${encodeURIComponent(streamerName)}`;
        const guestUrl = `${baseUrl}?game=${gameCode}&role=guest`;
        
        document.getElementById('hostUrl').textContent = hostUrl;
        document.getElementById('guestUrl').textContent = guestUrl;
        
        // Afficher le panneau de partie créée
        document.getElementById('gameCreatedInfo').style.display = 'block';
        this.style.display = 'none';
    });
    
    // Bouton rejoindre partie
    document.getElementById('joinGameBtn')?.addEventListener('click', function(e) {
        e.preventDefault(); // Empêcher le submit du formulaire
        
        const streamerName = document.getElementById('guestStreamerName').value;
        const gameCode = document.getElementById('gameCodeInput').value;
        
        if (!streamerName || !gameCode) {
            alert('Veuillez remplir tous les champs');
            return;
        }
        
        // Simuler la connexion
        const baseUrl = window.location.origin + window.location.pathname;
        const playerUrl = `${baseUrl}?game=${gameCode}&role=guest&streamer=${encodeURIComponent(streamerName)}`;
        
        document.getElementById('playerUrl').textContent = playerUrl;
        
        // Afficher le panneau de partie rejointe
        document.getElementById('gameJoinedInfo').style.display = 'block';
        this.style.display = 'none';
    });
    
    // Boutons de copie
    document.querySelectorAll('.btn-copy').forEach(btn => {
        btn.addEventListener('click', function() {
            const targetId = this.dataset.target;
            const text = document.getElementById(targetId).textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                this.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => {
                    this.innerHTML = '<i class="fas fa-copy"></i>';
                }, 2000);
            });
        });
    });
});
</script>

    <!-- Librairies principales -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" 
            integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" 
            crossorigin="anonymous"></script>
    
    <!-- Librairies d'échecs -->
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    
    <!-- Librairies de graphiques -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.1.0/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
    
    <!-- Twitch -->
    <script src="js/tmi.min.js"></script>
    <script src="js/client.js"></script>
    <script src="twitchToken.js"></script>
    
    <!-- Notre application -->
    <script src="js/config.js"></script>
    
    <!-- ChessboardArrows (version simple intégrée) -->
    <script>
        // Version simple de ChessboardArrows pour éviter les erreurs
        class ChessboardArrows {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                if (!this.container) {
                    console.warn(`Container ${containerId} not found for ChessboardArrows`);
                    return;
                }
                
                this.canvas = document.getElementById('drawing_canvas');
                this.ctx = this.canvas ? this.canvas.getContext('2d') : null;
                this.arrows = [];
                this.circles = [];
            }
            
            clearArrows() {
                if (this.ctx) {
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                }
                this.arrows = [];
                this.circles = [];
            }
            
            drawArrow(from, to, color = 'yellow', width = 8) {
                // Implementation basique - peut être étendue plus tard
                console.log(`Drawing arrow from ${from} to ${to}`);
            }
            
            drawCircle(square, color = 'green', filled = false) {
                // Implementation basique - peut être étendue plus tard  
                console.log(`Drawing circle on ${square}`);
            }
        }
        
        // Rendre ChessboardArrows disponible globalement
        window.ChessboardArrows = ChessboardArrows;
    </script>
    
    <!-- Script principal -->
    <script src="js/chessVoterApp.js"></script>
    
    <!-- Scripts de multiplayer et Socket.io (optionnels) -->
    <script>
        // Charger Socket.io seulement si un serveur est configuré
        if (window.CHESS_VOTER_CONFIG.serverUrl) {
            const script = document.createElement('script');
            script.src = 'https://cdn.socket.io/4.5.4/socket.io.min.js';
            script.onload = function() {
                console.log('✅ Socket.io chargé avec succès');
                
                // Détecter si on est en mode multiplayer via l'URL
                const urlParams = new URLSearchParams(window.location.search);
                const gameId = urlParams.get('game');
                const role = urlParams.get('role');
                
                if (gameId && role) {
                    window.multiplayerMode = true;
                    window.currentGameId = gameId;
                    window.playerColor = (role === 'host') ? 'white' : 'black';
                    
                    // Initialiser la connexion multiplayer
                    console.log(`🎮 Mode multiplayer activé - Game: ${gameId}, Role: ${role}`);
                }
            };
            document.head.appendChild(script);
        } else {
            console.log('ℹ️ Pas de serveur configuré - Mode solo uniquement');
        }
    </script>
    <script>
document.addEventListener('DOMContentLoaded', function() {
    const configForm = document.getElementById('configModal');
    const openButton = document.getElementById('openFormButton');
    const closeButton = document.querySelector('.close');
    
    // Ouvrir le formulaire
    if (openButton) {
        openButton.addEventListener('click', function(e) {
            e.preventDefault();
            if (configForm) {
                configForm.style.display = 'block';
            }
        });
    }
    
    // Fermer le formulaire
    if (closeButton) {
        closeButton.addEventListener('click', function() {
            if (configForm) {
                configForm.style.display = 'none';
            }
        });
    }
    
    // Fermer en cliquant à l'extérieur
    window.addEventListener('click', function(event) {
        if (event.target === configForm) {
            configForm.style.display = 'none';
        }
    });
});




/**
 * Simule des votes aléatoires de viewers fictifs
 * @param {number} voteCount - Nombre de votes à simuler (défaut: 10)
 * @param {boolean} showLogs - Afficher les logs des votes (défaut: true)
 * @returns {Array} - Liste des votes générés
 */
function simulateRandomVotes(voteCount = 10, showLogs = true) {
    if (!voteOpen) {
        console.warn("❌ Le vote n'est pas ouvert actuellement !");
        return [];
    }

    if (!chess || typeof chess.moves !== 'function') {
        console.warn("❌ Le jeu d'échecs n'est pas initialisé !");
        return [];
    }

    const availableMoves = chess.moves();
    if (availableMoves.length === 0) {
        console.warn("❌ Aucun coup disponible !");
        return [];
    }

    const simulatedVotes = [];
    const viewerNames = [
        'TestViewer1', 'TestViewer2', 'TestViewer3', 'TestViewer4', 'TestViewer5',
        'BotSimulator1', 'BotSimulator2', 'BotSimulator3', 'BotSimulator4', 'BotSimulator5',
        'FakeUser1', 'FakeUser2', 'FakeUser3', 'FakeUser4', 'FakeUser5',
        'SimUser1', 'SimUser2', 'SimUser3', 'SimUser4', 'SimUser5'
    ];

    console.log(`🎯 Simulation de ${voteCount} votes aléatoires...`);
    console.log(`📋 Coups disponibles: ${availableMoves.join(', ')}`);

    for (let i = 0; i < voteCount; i++) {
        // Sélectionner un coup aléatoire
        const randomMove = availableMoves[Math.floor(Math.random() * availableMoves.length)];
        
        // Sélectionner un nom de viewer aléatoire ou en générer un unique
        const viewerName = Math.random() > 0.7 ? 
            `RandomBot${Math.floor(Math.random() * 1000)}` : 
            viewerNames[Math.floor(Math.random() * viewerNames.length)];
        
        // Ajouter le vote (en respectant la limitation limitToOneVote si activée)
        const voteSuccess = addMoveToPoll(viewerName, randomMove);
        
        if (voteSuccess !== false) {
            simulatedVotes.push({ player: viewerName, move: randomMove });
            
            if (showLogs) {
                console.log(`✅ Vote ${i + 1}: ${viewerName} vote pour ${randomMove}`);
            }
        } else {
            if (showLogs) {
                console.log(`⚠️ Vote ${i + 1}: ${viewerName} a déjà voté (limitToOneVote activé)`);
            }
            
            // Si limitToOneVote est activé, essayer avec un nouveau nom
            if (limitToOneVote) {
                const uniqueName = `UniqueBot${Date.now()}_${i}`;
                const retrySuccess = addMoveToPoll(uniqueName, randomMove);
                if (retrySuccess !== false) {
                    simulatedVotes.push({ player: uniqueName, move: randomMove });
                    if (showLogs) {
                        console.log(`✅ Retry ${i + 1}: ${uniqueName} vote pour ${randomMove}`);
                    }
                }
            }
        }
        
        // Petit délai pour simuler le timing réel (optionnel)
        if (i < voteCount - 1) {
            // Utiliser setTimeout pour un délai non-bloquant si souhaité
            // await new Promise(resolve => setTimeout(resolve, 50));
        }
    }

    console.log(`🎉 Simulation terminée ! ${simulatedVotes.length} votes ajoutés.`);
    console.log(`📊 État actuel du poll:`, poll);
    
    // Afficher un résumé des votes
    const votesSummary = poll.reduce((acc, vote) => {
        acc[vote.move] = (acc[vote.move] || 0) + 1;
        return acc;
    }, {});
    
    console.log(`📈 Résumé des votes:`, votesSummary);
    
    return simulatedVotes;
}

/**
 * Simule des votes avec distribution pondérée (certains coups plus populaires)
 * @param {number} voteCount - Nombre de votes à simuler
 * @param {Array} popularMoves - Coups populaires (optionnel)
 * @returns {Array} - Liste des votes générés
 */
function simulateWeightedVotes(voteCount = 10, popularMoves = []) {
    if (!voteOpen || !chess) {
        console.warn("❌ Le vote n'est pas ouvert ou le jeu n'est pas initialisé !");
        return [];
    }

    const availableMoves = chess.moves();
    if (availableMoves.length === 0) {
        console.warn("❌ Aucun coup disponible !");
        return [];
    }

    // Si aucun coup populaire spécifié, prendre les 2-3 premiers coups
    if (popularMoves.length === 0) {
        popularMoves = availableMoves.slice(0, Math.min(3, availableMoves.length));
    }

    const simulatedVotes = [];
    
    console.log(`🎯 Simulation de ${voteCount} votes pondérés...`);
    console.log(`⭐ Coups populaires: ${popularMoves.join(', ')}`);

    for (let i = 0; i < voteCount; i++) {
        let selectedMove;
        
        // 70% de chance de voter pour un coup populaire
        if (Math.random() < 0.7 && popularMoves.length > 0) {
            selectedMove = popularMoves[Math.floor(Math.random() * popularMoves.length)];
        } else {
            selectedMove = availableMoves[Math.floor(Math.random() * availableMoves.length)];
        }
        
        const viewerName = `WeightedBot${Date.now()}_${i}`;
        const voteSuccess = addMoveToPoll(viewerName, selectedMove);
        
        if (voteSuccess !== false) {
            simulatedVotes.push({ player: viewerName, move: selectedMove });
            console.log(`✅ Vote ${i + 1}: ${viewerName} vote pour ${selectedMove}`);
        }
    }

    console.log(`🎉 Simulation pondérée terminée !`);
    return simulatedVotes;
}

/**
 * Simule une situation de vote serré entre 2 coups
 * @param {string} move1 - Premier coup
 * @param {string} move2 - Deuxième coup
 * @param {number} totalVotes - Nombre total de votes
 */
function simulateCloseVote(move1, move2, totalVotes = 20) {
    if (!voteOpen || !chess) {
        console.warn("❌ Le vote n'est pas ouvert ou le jeu n'est pas initialisé !");
        return [];
    }

    const availableMoves = chess.moves();
    
    // Vérifier que les coups sont valides
    if (!availableMoves.includes(move1) || !availableMoves.includes(move2)) {
        console.warn(`❌ Coups invalides ! Disponibles: ${availableMoves.join(', ')}`);
        return [];
    }

    console.log(`⚔️ Simulation d'un vote serré entre ${move1} et ${move2}...`);

    const simulatedVotes = [];
    
    for (let i = 0; i < totalVotes; i++) {
        // Alterner entre les deux coups avec un léger aléatoire
        const selectedMove = (i % 2 === 0) ? move1 : move2;
        const viewerName = `CloseVoteBot${Date.now()}_${i}`;
        
        const voteSuccess = addMoveToPoll(viewerName, selectedMove);
        if (voteSuccess !== false) {
            simulatedVotes.push({ player: viewerName, move: selectedMove });
            console.log(`✅ Vote ${i + 1}: ${viewerName} vote pour ${selectedMove}`);
        }
    }

    console.log(`🎉 Vote serré simulé ! Résultat final à voir...`);
    return simulatedVotes;
}

/**
 * Fonction rapide pour 10 votes aléatoires (raccourci)
 */
function quickVotes() {
    return simulateRandomVotes(10, true);
}

/**
 * Fonction pour vider les votes de test (utile pour nettoyer)
 */
function clearTestVotes() {
    // Garder seulement les votes qui ne sont pas des bots de test
    const originalPollLength = poll.length;
    poll = poll.filter(vote => 
        !vote.player.includes('TestViewer') && 
        !vote.player.includes('BotSimulator') && 
        !vote.player.includes('FakeUser') && 
        !vote.player.includes('SimUser') && 
        !vote.player.includes('RandomBot') && 
        !vote.player.includes('WeightedBot') && 
        !vote.player.includes('CloseVoteBot') && 
        !vote.player.includes('UniqueBot')
    );
    
    console.log(`🧹 Nettoyage effectué ! ${originalPollLength - poll.length} votes de test supprimés.`);
    
    // Mettre à jour l'affichage
    if (typeof updateChartIncremental === 'function') {
        // Reconstruire le graphique
        if (typeof pollChart !== 'undefined') {
            pollChart.data.labels = [];
            pollChart.data.datasets[0].data = [];
            pollChart.data.datasets[0].backgroundColor = [];
            pollChart.update();
            
            // Re-ajouter les votes restants
            poll.forEach(vote => {
                updateChartIncremental(vote.move, vote.color);
            });
        }
    }
}

// ======== INSTRUCTIONS D'UTILISATION ========
console.log(`
🎮 SIMULATEUR DE VOTES CHARGÉ !

Fonctions disponibles dans la console :

🎯 simulateRandomVotes(10)     - 10 votes aléatoires
⚡ quickVotes()                - Raccourci pour 10 votes rapides  
📊 simulateWeightedVotes(15)   - 15 votes pondérés vers coups populaires
⚔️ simulateCloseVote('e4','d4',20) - Vote serré entre 2 coups
🧹 clearTestVotes()            - Nettoyer les votes de test

Exemple d'utilisation :
> quickVotes()
> simulateCloseVote('Nf3', 'e4', 16)
> clearTestVotes()
`);
</script>
</body>
</html>