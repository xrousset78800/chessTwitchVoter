<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitchess</title>
    
    <!-- CSS : Chessboard.js officiel -->
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU" crossorigin="anonymous">
    
    <!-- CSS : Notre système modulaire -->
    <link rel="stylesheet" href="css2/main.css">
    
    <!-- Fonts et icônes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href='https://fonts.googleapis.com/css?family=Roboto+Condensed' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
</head>

<body data-team="w">
    <!-- Header principal -->
    <header class="main-header">
        <h1 data-lang="fr-FR">Twitchess</h1>
        <!-- Pièces disponibles -->
        <div class="sidebar-section">
            <h3 class="sidebar-section-title">Pièces disponibles</h3>
            <div class="available-pieces">
                <ul id="availableList">
                    <ul id="availableListP"></ul>
                    <ul id="availableListB"></ul>
                    <ul id="availableListN"></ul>
                    <ul id="availableListR"></ul>
                    <ul id="availableListQ"></ul>
                    <ul id="availableListK"></ul>
                </ul>
            </div>
        </div>
    </header>

    <!-- Layout principal -->
    <main class="main-content">
        <!-- Section échiquier -->
        <section class="board-section">
            <div id="board_wrapper">
                <canvas id="primary_canvas" width="630" height="630"></canvas>
                <canvas id="drawing_canvas" width="630" height="630"></canvas>
                <div id="myBoard" style="width: 630px;"></div>
            </div>
        </section>

        <!-- Sidebar avec informations -->
        <aside class="sidebar game-info">
            <!-- Section votes -->
            <div class="sidebar-section">
                <h3 class="sidebar-section-title">Votes & Statut</h3>
                <div class="votes">
                    <!-- Statuts du jeu -->
                    <h3 data-lang="fr-FR" data-team="w">Trait aux blancs</h3>
                    <h3 data-lang="fr-FR" data-team="b">Trait aux noirs</h3>
                    <h4 data-lang="en-EN" class="status"></h4>
                    
                    <!-- Liste des votes -->
                    <ol class="prefixed styled"></ol>
                    
                    <!-- Graphique des votes -->
                    <div class="chart-container">
                        <canvas id="chartPoll" width="600" height="150"></canvas>
                    </div>
                    
                    <!-- Graphique D3 alternatif -->
                    <div id="chart"></div>
                </div>
            </div>

            <!-- Historique des coups -->
            <div class="sidebar-section">
                <h3 class="sidebar-section-title">Historique</h3>
                <div class="poll prefixed styled">
                    <ol></ol>
                </div>
            </div>
        </aside>
    </main>

    <!-- Section problèmes d'échecs -->
    <section id="probleminfo" class="problem-section">
        <div class="problem-details">
            <div class="problem-meta">
                <span>Ouverture : </span>
                <span data-opening=""></span>
            </div>
            <div class="problem-stats">
                <span data-attempt="">0</span> / <span data-length="">0</span>
                <span data-solution="" style="display: none;"></span>
                <span data-fen="" style="display: none;"></span>
            </div>
        </div>
    </section>

    <!-- Timer affiché -->
    <div id="timer-display" class="timer-display">
        <span id="timer-value">00:00</span>
    </div>

    <!-- Modal de configuration -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Configuration</h2>
            <form id="configForm">
                <fieldset>
                    <legend>Paramètres d'affichage</legend>
                    
                    <div class="form-group">
                        <input type="checkbox" id="noBg" name="noBg">
                        <label for="noBg">Mode sans fond (améliore les performances)</label>
                        <i class="fas fa-image"></i>
                    </div>
                    
                    <div class="form-group">
                        <input type="checkbox" id="noEpilepsy" name="noEpilepsy">
                        <label for="noEpilepsy">Mode anti épilepsie (supprime le switch de background)</label>
                        <i class="fas fa-heart"></i>
                    </div>
                </fieldset>
                <!-- Interface de sélection de thèmes -->
                <section id="themeSelection" class="theme-section">
                    <div class="theme-header">
                        <h3>Sélection des thèmes</h3>
                        <div class="theme-controls">
                            <button onclick="selectAllThemes()" class="btn btn-secondary">Tout sélectionner</button>
                            <button onclick="clearThemeFilter()" class="btn btn-secondary">Tout effacer</button>
                        </div>
                    </div>
                    
                    <div id="selectedThemes" class="selected-themes">
                        <h4>Thèmes sélectionnés :</h4>
                        <div id="selectedThemesTags" class="theme-tags"></div>
                    </div>
                    
                    <div class="theme-stats">
                        Problèmes disponibles : <span id="availableProblems">0</span>
                    </div>
                    
                    <div id="themeList" class="theme-list">
                        <!-- Les thèmes seront chargés dynamiquement ici -->
                    </div>
                </section>
                <button type="submit" class="form-btn">
                    Sauvegarde + reload
                    <i class="fas fa-save"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- Bouton d'ouverture de la configuration -->
    <button id="openFormButton" class="config-button">
        <i class="fas fa-cog"></i>
    </button>

    <!-- Scripts JavaScript -->
    
    <!-- Configuration globale -->
    <script>
        // Configuration pour la production
        window.CHESS_VOTER_CONFIG = {
            basePath: '/chessTwitchVoter/',
            serverUrl: null, // Mettez l'URL de votre serveur si vous en avez un
            isProduction: window.location.hostname !== 'localhost'
        };
        
        // Variables globales pour le multiplayer
        window.multiplayerMode = false;
        window.gameSocket = null;
        window.currentGameId = null;
        window.playerColor = null;
    </script>

    <!-- Librairies principales -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" 
            integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" 
            crossorigin="anonymous"></script>
    
    <!-- Librairies d'échecs -->
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    
    <!-- Librairies de graphiques -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.1.0/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
    
    <!-- Twitch -->
    <script src="js/tmi.min.js"></script>
    <script src="js/client.js"></script>
    <script src="twitchToken.js"></script>
    
    <!-- Notre application -->
    <script src="js/config.js"></script>
    
    <!-- ChessboardArrows (version simple intégrée) -->
    <script>
        // Version simple de ChessboardArrows pour éviter les erreurs
        class ChessboardArrows {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                if (!this.container) {
                    console.warn(`Container ${containerId} not found for ChessboardArrows`);
                    return;
                }
                
                this.canvas = document.getElementById('drawing_canvas');
                this.ctx = this.canvas ? this.canvas.getContext('2d') : null;
                this.arrows = [];
                this.circles = [];
            }
            
            clearArrows() {
                if (this.ctx) {
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                }
                this.arrows = [];
                this.circles = [];
            }
            
            drawArrow(from, to, color = 'yellow', width = 8) {
                // Implementation basique - peut être étendue plus tard
                console.log(`Drawing arrow from ${from} to ${to}`);
            }
            
            drawCircle(square, color = 'green', filled = false) {
                // Implementation basique - peut être étendue plus tard  
                console.log(`Drawing circle on ${square}`);
            }
        }
        
        // Rendre ChessboardArrows disponible globalement
        window.ChessboardArrows = ChessboardArrows;
    </script>
    
    <!-- Script principal -->
    <script src="js/chessVoterApp.js"></script>
    
    <!-- Scripts de multiplayer et Socket.io (optionnels) -->
    <script>
        // Charger Socket.io seulement si un serveur est configuré
        if (window.CHESS_VOTER_CONFIG.serverUrl) {
            const script = document.createElement('script');
            script.src = 'https://cdn.socket.io/4.5.4/socket.io.min.js';
            script.onload = function() {
                console.log('✅ Socket.io chargé avec succès');
                
                // Détecter si on est en mode multiplayer via l'URL
                const urlParams = new URLSearchParams(window.location.search);
                const gameId = urlParams.get('game');
                const role = urlParams.get('role');
                
                if (gameId && role) {
                    window.multiplayerMode = true;
                    window.currentGameId = gameId;
                    window.playerColor = (role === 'host') ? 'white' : 'black';
                    
                    // Initialiser la connexion multiplayer
                    console.log(`🎮 Mode multiplayer activé - Game: ${gameId}, Role: ${role}`);
                }
            };
            document.head.appendChild(script);
        } else {
            console.log('ℹ️ Pas de serveur configuré - Mode solo uniquement');
        }
    </script>
</body>
</html>