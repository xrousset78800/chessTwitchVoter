<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitchess</title>
    
    <!-- CSS : Chessboard.js officiel -->
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU" crossorigin="anonymous">
    
    <!-- CSS : Notre système modulaire -->
    <link rel="stylesheet" href="css2/main.css">
    
    <!-- Fonts et icônes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href='https://fonts.googleapis.com/css?family=Roboto+Condensed' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
    <base href="./">
</head>

<body data-team="w">
    <!-- Header principal -->
    <header class="main-header">
        <h1 data-lang="fr-FR">Twitchess</h1>
        <!-- Statuts du jeu -->
        <h5 id="gameTitle"></h5>
        <h3 data-lang="fr-FR" data-team="w">Trait aux blancs</h3>
        <h3 data-lang="fr-FR" data-team="b">Trait aux noirs</h3>
        <h4 data-lang="en-EN" class="status"></h4>
        <!-- Pièces disponibles -->
        <div class="sidebar-section">
            <h3 class="sidebar-section-title">Coups disponibles</h3>
            <div class="available-pieces">
                <ul id="availableList">
                    <ul id="availableListP"></ul>
                    <ul id="availableListB"></ul>
                    <ul id="availableListN"></ul>
                    <ul id="availableListR"></ul>
                    <ul id="availableListQ"></ul>
                    <ul id="availableListK"></ul>
                </ul>
            </div>
        </div>
    </header>

    <!-- Layout principal -->
    <main class="main-content">
        <!-- Section échiquier -->
        <section class="board-section">
            <div id="board_wrapper">
                <canvas id="primary_canvas" width="630" height="630"></canvas>
                <canvas id="drawing_canvas" width="630" height="630"></canvas>
                <div id="myBoard" style="width: 630px;"></div>
            </div>

                            <div class="votes">                    
                    <!-- Liste des votes -->
                    <ol class="prefixed styled"></ol>
                    
                    <!-- Graphique des votes -->
                    <div class="chart-container">
                        <canvas id="chartPoll" width="600" height="150"></canvas>
                    </div>
                    
                    <!-- Graphique D3 alternatif -->
                    <div id="chart"></div>
                </div>
        </section>

        <!-- Sidebar avec informations -->
        <aside class="sidebar game-info">
            <!-- Historique des coups -->
            <div class="sidebar-section">
                <h3 class="sidebar-section-title">Historique</h3>
                <div class="poll prefixed styled">
                    <ol></ol>
                </div>
            </div>
        </aside>
    </main>

    <!-- Section problèmes d'échecs -->
    <section id="probleminfo" class="problem-section">
        <div class="problem-details">
            <div class="problem-meta">
                <span>Ouverture : </span>
                <span data-opening=""></span>
            </div>
            <div class="problem-stats">
                <span data-attempt="">0</span> / <span data-length="">0</span>
                <span data-omgSolution="" style="display: none;"></span>
                <span data-fen="" style="display: none;"></span>
            </div>
        </div>
    </section>

    <!-- Timer affiché -->
    <div id="timer-display" class="timer-display">
            <div class="countdown">
        <svg viewBox="0 0 100 100">
            <circle r="45" cx="50" cy="50" fill="transparent" stroke="#333" stroke-width="3"/>
            <circle r="45" cx="50" cy="50" fill="transparent" stroke="#667eea" stroke-width="3"
                    stroke-dasharray="283" stroke-dashoffset="0"
                    stroke-linecap="round" transform="rotate(-90 50 50)"/>
                    <span id="timer-value">00:00</span>
        </svg>
    </div>
        
    </div>

    <!-- Timer circulaire classique (existant, gardé pour compatibilité) -->


    <!-- Modal de configuration -->
    <div id="configModal" class="modal">
        <div class="modal-content">
        <form id="configForm">
            <span class="close">&times;</span>
            <h2>Configuration</h2>
            <fieldset class="twitch">
                <legend>Connexion avec la chaine Twitch</legend>
                <label for="defaultChannel">Enter twitch channel&nbsp;</label>
                <input type="text" id="defaultChannel" name="defaultChannel" >
                <span class="tooltip-icon" data-tooltip="Chaine twitch avec laquelle se connecter">?</span>
            </fieldset>
            <fieldset class="gameMode">
                <legend>Mode de jeu</legend>            
                <input type="radio" id="yoloMode" name="gameMode" value="normal">
                <label for="yoloMode">Jouer en mode YOLO (sandbox)</label>
                <span class="tooltip-icon" data-tooltip="Gros bordel, tout le monde peut voter pour tout le monde au sein d'une chaine. Utile pour tester">?</span>
                <br>
                <input type="radio" id="probMode" name="gameMode" value="probMode">
                <label for="probMode">Jouer en mode problèmes (ok but fix vote/reload issues)</label>
                <span class="tooltip-icon" data-tooltip="Jouer en mode probèmes !">?</span>
                <div data-game-mode="probMode">
                    <fieldset class="theme-filter-section">
                            <legend>Filtrage par thèmes</legend>
                            
                            <div class="filter-controls">
                                <button type="button" class="btn btn-secondary" onclick="selectAllThemes()">
                                    Tout sélectionner
                                </button>
                                <button type="button" class="btn btn-danger" onclick="clearThemeFilter()">
                                    Effacer la sélection
                                </button>
                            </div>
                            
                            <div class="problem-count" id="problemCount">
                                <span id="availableProblems">-</span>
                            </div>
                            
                            <div class="theme-list" id="themeList">
                                <!-- Les thèmes seront générés dynamiquement -->
                            </div>
                            
                            <div class="selected-themes" id="selectedThemes" style="display: none;">
                                <div id="selectedThemesTags"></div>
                            </div>
                            </fieldset>
                        </div>
                <br>
                <input type="radio" id="mod1vViewers" name="gameMode" value="mod1vViewers">
                <label for="mod1vViewers">Seul contre tous (wip)</label>
                <span class="tooltip-icon" data-tooltip="Sur une chaine, une personne séléctionnée contre tout les autres">?</span>
                <div data-game-mode="mod1vViewers">
                    <label for="mod1vViewersPlayer">Pseudo du joueur&nbsp;</label>
                    <input type="text" id="mod1vViewersPlayer" name="mod1vViewersPlayer" >
                    </div>
                    <br>
                <input type="radio" id="mod1v1" name="gameMode" value="mod1v1">
                <label for="mod1v1">Un contre un (ok?)</label>
                <span class="tooltip-icon" data-tooltip="Chaque viewer ne peut voter qu'une seule fois par tour">?</span>
                <div data-game-mode="mod1v1">
                    <label for="oneVsOneModeList0">Pseudo du Joueur1&nbsp;</label><input type="text" id="oneVsOneModeList0" name="oneVsOneModeList0">
                    <br>
                    <label for="oneVsOneModeList1">Pseudo du Joueur2&nbsp;</label><input type="text" id="oneVsOneModeList1" name="oneVsOneModeList1">
                </div>
                <br>
                <input type="radio" id="modStreamerChatvStreamerChat" name="gameMode" value="modStreamerChatvStreamerChat">
                <label for="modStreamerChatvStreamerChat">Chat contre Chat (ok?)</label>
                <span class="tooltip-icon" data-tooltip="Les chats des 2 streams s'affrontent en votant (penser à activer le vote)">?</span>
                <div data-game-mode="modStreamerChatvStreamerChat" class="multiplayer-setup">
                    <div class="multiplayer-tabs">
                        <div class="multiplayer-tab create active" data-tab="create">
                            <i class="fas fa-crown"></i>
                            <h3>Créer une partie</h3>
                            <p>Hébergez et invitez un autre streameur</p>
                        </div>
                        <div class="multiplayer-tab join" data-tab="join">
                            <i class="fas fa-sign-in-alt"></i>
                            <h3>Rejoindre une partie</h3>
                            <p>Connectez-vous avec un code</p>
                        </div>
                    </div>
                    
                    <!-- Contenu -->
                    <div class="multiplayer-content">
                        <!-- Panneau Créer -->
                        <div id="create-panel" class="multiplayer-panel active">
                            <div class="form-group">
                                <label for="hostStreamerName">
                                    <i class="fab fa-twitch"></i> Votre nom de streameur
                                </label>
                                <input type="text" id="hostStreamerName" name="streamerChatvStreamerChat0" class="form-control" placeholder="VotreNomTwitch">
                            </div>
                            
                            <button type="button" class="btn btn-primary" id="createGameBtn">
                                <i class="fas fa-plus"></i> Créer la partie
                            </button>
                            
                            <!-- Panneau de partie créée -->
                            <div id="gameCreatedInfo" class="game-created" style="display: none;">
                                <h4>✅ Partie créée !</h4>
                                
                                <div style="margin: 15px 0;">
                                    <span>Code de partie :</span>
                                    <div class="game-code" id="gameCode">XXXX</div>
                                </div>
                                
                                <div style="margin: 15px 0;">
                                    <span>Statut :</span>
                                    <span class="status status-waiting" id="gameStatus">En attente...</span>
                                </div>
                                
                                <div class="url-section">
                                    <label>Votre URL (Blancs) :</label>
                                    <div class="url-box">
                                        <span id="hostUrl">-</span>
                                        <button class="btn-copy" data-target="hostUrl">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="url-section">
                                    <label>URL pour l'adversaire (Noirs) :</label>
                                    <div class="url-box">
                                        <span id="guestUrl">-</span>
                                        <button class="btn-copy" data-target="guestUrl">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Panneau Rejoindre -->
                        <div id="join-panel" class="multiplayer-panel">
                            <div class="form-group">
                                <label for="guestStreamerName">
                                    <i class="fab fa-twitch"></i> Votre nom de streameur
                                </label>
                                <input type="text" id="guestStreamerName" name="streamerChatvStreamerChat1" class="form-control" placeholder="VotreNomTwitch">
                            </div>
                            
                            <div class="form-group">
                                <label for="gameCodeInput">
                                    <i class="fas fa-key"></i> Code de la partie
                                </label>
                                <input type="text" id="gameCodeInput" class="form-control game-code-input" placeholder="XXXX" maxlength="4">
                            </div>
                            
                            <button type="button" class="btn btn-primary" id="joinGameBtn">
                                <i class="fas fa-sign-in-alt"></i> Rejoindre
                            </button>
                            
                            <!-- Panneau de partie rejointe -->
                            <div id="gameJoinedInfo" class="game-joined" style="display: none;">
                                <h4>✅ Connecté !</h4>
                                
                                <div style="margin: 15px 0;">
                                    <span>Statut :</span>
                                    <span class="status status-connected">Prêt</span>
                                </div>
                                
                                <div class="url-section">
                                    <label>Votre URL (Noirs) :</label>
                                    <div class="url-box">
                                        <span id="playerUrl">-</span>
                                        <button class="btn-copy" data-target="playerUrl">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <br>
                <input type="radio" id="modViewersvViewers" name="gameMode" value="modViewersvViewers">
                <label for="modViewersvViewers">Tous contre tous (id pair/impair)(ok but cringe)</label>
                <span class="tooltip-icon" data-tooltip="Sur une même chaine, les ID pairs/impairs s'affrontent">?</span>
                <br>
                <input disabled="disabled" type="radio" id="modPuzzleRush" name="gameMode" value="modPuzzleRush">
                <label for="modPuzzleRush"><s>Puzzle rush ?</s></label>
                <span class="tooltip-icon" data-tooltip="Puzzle rush en double chaine twitch ?">?</span>
            </fieldset>

            <fieldset>
            <legend>Mode Vote !</legend> 
            <input type="checkbox" data-mode="timerMode" id="timerMode" name="timerMode">
            <label for="timerMode">Activer le mode vote</label>
            <span class="tooltip-icon" data-tooltip="Active le timer et la fonction de vote">?</span>
            <div data-time-mode>
                <label for="InitialvoterTimer">Temps d'un tour</label>
                <input type="number" id="InitialvoterTimer" name="InitialvoterTimer" min="0"> s
                <span class="tooltip-icon" data-tooltip="Durée d'un tour de vote pour une partie">?</span>
                <br>                
                <label for="timerWheelAnimation">Animation de la roue </label>
                <input type="number" id="timerWheelAnimation" name="timerWheelAnimation" min="0"> s
                <span class="tooltip-icon" data-tooltip="Durée de l'animation de la roue">?</span>
                <br>
                <input type="checkbox" id="limitToOneVote" name="limitToOneVote">
                <label for="limitToOneVote">Vote unique</label>
                <span class="tooltip-icon" data-tooltip="Chaque viewer ne peut voter qu'une seule fois par tour">?</span>
                <br>
                <input type="checkbox" id="majorityMode" name="majorityMode">               
                <label for="majorityMode">Majorité ? / (sinon tirage au sort)</label>
                <span class="tooltip-icon" data-tooltip="Si coché, la majorité sur le vote est joué automatiquement. Sinon il y aura toujours un tirage au sort">?</span>

            </div>
        </fieldset>         
            <fieldset>
                <legend>Options de timer</legend> 
                <label for="pauseAfterWinLose">Durée de la pause</label>
                <input type="number" id="pauseAfterWinLose" name="pauseAfterWinLose" min="0"> s
                <span class="tooltip-icon" data-tooltip="Durée de la pause entre les parties ou les problèmes avant de relancer automatiquement">?</span>
        </fieldset>
                <fieldset>
                    <legend>Restrictions d'accès</legend>
                    <input type="checkbox" id="followMode" name="followMode">
                    <label for="followMode">Mode followers uniquement</label>
                    <span class="tooltip-icon" data-tooltip="Seuls les followers de la chaine peuvent voter">?</span>
                    <br>
                    <input type="checkbox" id="subMode" name="subMode">
                    <label for="subMode">Mode abonnés uniquement</label>
                    <span class="tooltip-icon" data-tooltip="Seuls les abonnés de la chaine peuvent voter">?</span>
                    <br>
                    <small style="color: #aaa; font-size: 12px;">
                        Note: Les modérateurs, VIPs et le broadcaster peuvent toujours jouer
                    </small>
                </fieldset>
            <fieldset>
                <legend>Autres options</legend> 
            <input disabled="disabled" type="checkbox" id="noBg" name="noBg">
            <label for="noBg"><s>Supprimer le background (test sur OBS ?)</s></label>
            <span class="tooltip-icon" data-tooltip="Fond vert en option pour intégration OBS (WIP)">?</span>
            <br>
            <input disabled="disabled" type="checkbox" id="phantomChess" name="gameMode" value="phantomChess">
            <label for="phantomChess"><s>Phantom chess integration ?</s></label>
            <span class="tooltip-icon" data-tooltip="Intégration de l'échiquier automatique phantomChess (WIP)">?</span>
        </fieldset>

        <button type="submit" class="form-btn">Sauvegarde + reload<i class="fas fa-save"></i></button>
    </form>
        </div>
    </div>

    <!-- Bouton d'ouverture de la configuration -->
    <button id="openFormButton" class="config-button">
        <i class="fas fa-cog"></i>
    </button>

    <!-- Scripts JavaScript -->
    
    <!-- Configuration globale -->
    <script>
        // Configuration pour la production
        window.CHESS_VOTER_CONFIG = {
            basePath: '/chessTwitchVoter/',
            serverUrl: null, // Mettez l'URL de votre serveur si vous en avez un
            isProduction: window.location.hostname !== 'localhost'
        };
        
        // Variables globales pour le multiplayer
        window.multiplayerMode = false;
        window.gameSocket = null;
        window.currentGameId = null;
        window.playerColor = null;
    </script>

<script>
// JavaScript pour gérer l'interface multiplayer
document.addEventListener('DOMContentLoaded', function() {
    // Gestion des onglets
    document.querySelectorAll('.multiplayer-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabName = this.dataset.tab;
            
            // Activer l'onglet
            document.querySelectorAll('.multiplayer-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // Afficher le panneau correspondant
            document.querySelectorAll('.multiplayer-panel').forEach(panel => panel.classList.remove('active'));
            document.getElementById(tabName + '-panel').classList.add('active');
        });
    });
    
    // Bouton créer partie
    document.getElementById('createGameBtn')?.addEventListener('click', function(e) {
        e.preventDefault(); // Empêcher le submit du formulaire
        
        const streamerName = document.getElementById('hostStreamerName').value;
        if (!streamerName) {
            alert('Veuillez entrer votre nom de streameur');
            return;
        }
        
        // Simuler la création de partie
        const gameCode = Math.random().toString(36).substring(2, 6).toUpperCase();
        document.getElementById('gameCode').textContent = gameCode;
        
        // Générer les URLs
        const baseUrl = window.location.origin + window.location.pathname;
        const hostUrl = `${baseUrl}?game=${gameCode}&role=host&streamer=${encodeURIComponent(streamerName)}`;
        const guestUrl = `${baseUrl}?game=${gameCode}&role=guest`;
        
        document.getElementById('hostUrl').textContent = hostUrl;
        document.getElementById('guestUrl').textContent = guestUrl;
        
        // Afficher le panneau de partie créée
        document.getElementById('gameCreatedInfo').style.display = 'block';
        this.style.display = 'none';
    });
    
    // Bouton rejoindre partie
    document.getElementById('joinGameBtn')?.addEventListener('click', function(e) {
        e.preventDefault(); // Empêcher le submit du formulaire
        
        const streamerName = document.getElementById('guestStreamerName').value;
        const gameCode = document.getElementById('gameCodeInput').value;
        
        if (!streamerName || !gameCode) {
            alert('Veuillez remplir tous les champs');
            return;
        }
        
        // Simuler la connexion
        const baseUrl = window.location.origin + window.location.pathname;
        const playerUrl = `${baseUrl}?game=${gameCode}&role=guest&streamer=${encodeURIComponent(streamerName)}`;
        
        document.getElementById('playerUrl').textContent = playerUrl;
        
        // Afficher le panneau de partie rejointe
        document.getElementById('gameJoinedInfo').style.display = 'block';
        this.style.display = 'none';
    });
    
    // Boutons de copie
    document.querySelectorAll('.btn-copy').forEach(btn => {
        btn.addEventListener('click', function() {
            const targetId = this.dataset.target;
            const text = document.getElementById(targetId).textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                this.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => {
                    this.innerHTML = '<i class="fas fa-copy"></i>';
                }, 2000);
            });
        });
    });
});
</script>

    <!-- Librairies principales -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" 
            integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" 
            crossorigin="anonymous"></script>
    
    <!-- Librairies d'échecs -->
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    
    <!-- Librairies de graphiques -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.1.0/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
    
    <!-- Twitch -->
    <script src="js/tmi.min.js"></script>
    <script src="js/client.js"></script>
    <script src="twitchToken.js"></script>
    
    <!-- Notre application -->
    <script src="js/config.js"></script>
    
    <!-- ChessboardArrows (version simple intégrée) -->
    <script>
        // Version simple de ChessboardArrows pour éviter les erreurs
        class ChessboardArrows {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                if (!this.container) {
                    console.warn(`Container ${containerId} not found for ChessboardArrows`);
                    return;
                }
                
                this.canvas = document.getElementById('drawing_canvas');
                this.ctx = this.canvas ? this.canvas.getContext('2d') : null;
                this.arrows = [];
                this.circles = [];
            }
            
            clearArrows() {
                if (this.ctx) {
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                }
                this.arrows = [];
                this.circles = [];
            }
            
            drawArrow(from, to, color = 'yellow', width = 8) {
                // Implementation basique - peut être étendue plus tard
                console.log(`Drawing arrow from ${from} to ${to}`);
            }
            
            drawCircle(square, color = 'green', filled = false) {
                // Implementation basique - peut être étendue plus tard  
                console.log(`Drawing circle on ${square}`);
            }
        }
        
        // Rendre ChessboardArrows disponible globalement
        window.ChessboardArrows = ChessboardArrows;
    </script>
    
    <!-- Script principal -->
    <script src="js/chessVoterApp.js"></script>
    
    <!-- Scripts de multiplayer et Socket.io (optionnels) -->
    <script>
        // Charger Socket.io seulement si un serveur est configuré
        if (window.CHESS_VOTER_CONFIG.serverUrl) {
            const script = document.createElement('script');
            script.src = 'https://cdn.socket.io/4.5.4/socket.io.min.js';
            script.onload = function() {
                console.log('✅ Socket.io chargé avec succès');
                
                // Détecter si on est en mode multiplayer via l'URL
                const urlParams = new URLSearchParams(window.location.search);
                const gameId = urlParams.get('game');
                const role = urlParams.get('role');
                
                if (gameId && role) {
                    window.multiplayerMode = true;
                    window.currentGameId = gameId;
                    window.playerColor = (role === 'host') ? 'white' : 'black';
                    
                    // Initialiser la connexion multiplayer
                    console.log(`🎮 Mode multiplayer activé - Game: ${gameId}, Role: ${role}`);
                }
            };
            document.head.appendChild(script);
        } else {
            console.log('ℹ️ Pas de serveur configuré - Mode solo uniquement');
        }
    </script>
    <script>
document.addEventListener('DOMContentLoaded', function() {
    const configForm = document.getElementById('configModal');
    const openButton = document.getElementById('openFormButton');
    const closeButton = document.querySelector('.close');
    
    // Ouvrir le formulaire
    if (openButton) {
        openButton.addEventListener('click', function(e) {
            e.preventDefault();
            if (configForm) {
                configForm.style.display = 'block';
            }
        });
    }
    
    // Fermer le formulaire
    if (closeButton) {
        closeButton.addEventListener('click', function() {
            if (configForm) {
                configForm.style.display = 'none';
            }
        });
    }
    
    // Fermer en cliquant à l'extérieur
    window.addEventListener('click', function(event) {
        if (event.target === configForm) {
            configForm.style.display = 'none';
        }
    });
});

function simulateSmartVotes(voteCount = 10, showLogs = true) {
    if (!voteOpen) {
        console.warn("❌ Le vote n'est pas ouvert actuellement !");
        return { success: 0, rejected: 0, errors: ['Vote fermé'] };
    }

    if (!chess || typeof chess.moves !== 'function') {
        console.warn("❌ Le jeu d'échecs n'est pas initialisé !");
        return { success: 0, rejected: 0, errors: ['Jeu non initialisé'] };
    }

    const availableMoves = chess.moves();
    if (availableMoves.length === 0) {
        console.warn("❌ Aucun coup disponible !");
        return { success: 0, rejected: 0, errors: ['Aucun coup disponible'] };
    }

    let successfulVotes = 0;
    let rejectedVotes = 0;
    const errors = [];
    const results = [];

    console.log(`🎯 Simulation intelligente de ${voteCount} votes...`);
    console.log(`🎮 Mode de jeu: ${gameMode}`);
    console.log(`⚪⚫ Tour actuel: ${teamToPlay === 0 ? 'Blancs' : 'Noirs'}`);
    console.log(`📋 Coups disponibles: ${availableMoves.join(', ')}`);

    for (let i = 0; i < voteCount; i++) {
        const voter = generateSmartVoter(i);
        const move = availableMoves[Math.floor(Math.random() * availableMoves.length)];
        
        // Simuler un contexte Twitch réaliste
        const context = createMockContext(voter, i);
        
        // Tester si le vote serait accepté selon les règles
        const voteResult = testVotePermissions(voter, move, context, showLogs);
        
        if (voteResult.allowed) {
            const voteSuccess = addMoveToPoll(voter.username, move);
            if (voteSuccess !== false) {
                successfulVotes++;
                results.push({ voter: voter.username, move, result: 'success' });
                if (showLogs) {
                    console.log(`✅ Vote ${i + 1}: ${voter.username} vote pour ${move} - ACCEPTÉ`);
                }
            } else {
                rejectedVotes++;
                results.push({ voter: voter.username, move, result: 'duplicate' });
                if (showLogs) {
                    console.log(`⚠️ Vote ${i + 1}: ${voter.username} - Vote en double`);
                }
            }
        } else {
            rejectedVotes++;
            errors.push(voteResult.reason);
            results.push({ voter: voter.username, move, result: 'rejected', reason: voteResult.reason });
            if (showLogs) {
                console.log(`❌ Vote ${i + 1}: ${voter.username} - REJETÉ (${voteResult.reason})`);
            }
        }
    }

    const summary = {
        success: successfulVotes,
        rejected: rejectedVotes,
        total: voteCount,
        errors: [...new Set(errors)], // Erreurs uniques
        results: results
    };

    console.log(`📊 RÉSUMÉ:`);
    console.log(`✅ Votes acceptés: ${successfulVotes}/${voteCount}`);
    console.log(`❌ Votes rejetés: ${rejectedVotes}/${voteCount}`);
    console.log(`🔍 Types d'erreurs:`, summary.errors);

    return summary;
}

/**
 * Génère un voter intelligent selon le mode de jeu
 */
function generateSmartVoter(index) {
    const voterTypes = {
        normal: () => ({ username: `Viewer${Date.now()}_${index}`, type: 'viewer' }),
        
        mod1v1: () => {
            // Alterner entre les deux joueurs 1v1
            const players = [oneVsOneModeList0, oneVsOneModeList1];
            return { 
                username: players[index % 2], 
                type: '1v1_player',
                expectedTurn: index % 2
            };
        },
        
        mod1vViewers: () => {
            // Mélanger entre le joueur solo et des viewers
            if (Math.random() < 0.3) {
                return { username: mod1vViewersPlayer, type: 'solo_player' };
            } else {
                return { username: `Viewer${Date.now()}_${index}`, type: 'viewer' };
            }
        },
        
        modViewersvViewers: () => ({
            username: `Viewer${Date.now()}_${index}`,
            type: 'viewer',
            userId: Math.floor(Math.random() * 1000) // ID aléatoire pour test pair/impair
        }),
        
        modStreamerChatvStreamerChat: () => {
            const streamers = [streamerChatvStreamerChat0, streamerChatvStreamerChat1];
            return {
                username: `${streamers[index % 2]}_viewer_${index}`,
                type: 'streamer_viewer',
                channel: streamers[index % 2]
            };
        }
    };

    return voterTypes[gameMode] ? voterTypes[gameMode]() : voterTypes.normal();
}

/**
 * Crée un contexte Twitch simulé
 */
function createMockContext(voter, index) {
    return {
        username: voter.username,
        'user-id': voter.userId || index,
        subscriber: Math.random() < 0.3,
        follower: Math.random() < 0.7,
        mod: Math.random() < 0.05
    };
}

/**
 * Teste les permissions de vote selon les règles du mode de jeu
 */
function testVotePermissions(voter, move, context, showLogs) {
    // Vérifications générales
    if (!voteOpen) {
        return { allowed: false, reason: 'Vote fermé' };
    }

    // Restrictions par abonnement/follow
    if (typeof subMode !== 'undefined' && subMode && !context.subscriber) {
        return { allowed: false, reason: 'Subs seulement' };
    }
    
    if (typeof followMode !== 'undefined' && followMode && !context.follower) {
        return { allowed: false, reason: 'Followers seulement' };
    }

    // Vérifications spécifiques par mode de jeu
    switch(gameMode) {
        case 'mod1v1':
            if (context.username === oneVsOneModeList0 && teamToPlay === 1) {
                return { allowed: false, reason: `Tour des Noirs (${oneVsOneModeList1})` };
            }
            if (context.username === oneVsOneModeList1 && teamToPlay === 0) {
                return { allowed: false, reason: `Tour des Blancs (${oneVsOneModeList0})` };
            }
            if (context.username !== oneVsOneModeList0 && context.username !== oneVsOneModeList1) {
                return { allowed: false, reason: 'Pas un joueur du 1v1' };
            }
            break;

        case 'mod1vViewers':
            if (context.username === mod1vViewersPlayer && teamToPlay === 1) {
                return { allowed: false, reason: 'Tour des viewers' };
            }
            if (context.username !== mod1vViewersPlayer && teamToPlay === 0) {
                return { allowed: false, reason: `Tour de ${mod1vViewersPlayer}` };
            }
            break;

        case 'modViewersvViewers':
            const userId = context['user-id'] || 0;
            if (userId % 2 === 0 && teamToPlay === 1) {
                return { allowed: false, reason: 'Tour des Noirs (ID impairs)' };
            }
            if (userId % 2 === 1 && teamToPlay === 0) {
                return { allowed: false, reason: 'Tour des Blancs (ID pairs)' };
            }
            break;

        case 'modStreamerChatvStreamerChat':
            // Logique simplifiée pour le test - normalement il faudrait vérifier le channel
            const isStreamer1Viewer = voter.channel === streamerChatvStreamerChat0;
            const isStreamer2Viewer = voter.channel === streamerChatvStreamerChat1;
            
            if (isStreamer1Viewer && teamToPlay === 1) {
                return { allowed: false, reason: `Tour de ${streamerChatvStreamerChat1}` };
            }
            if (isStreamer2Viewer && teamToPlay === 0) {
                return { allowed: false, reason: `Tour de ${streamerChatvStreamerChat0}` };
            }
            break;
    }

    return { allowed: true, reason: 'Autorisé' };
}

/**
 * Fonction pour tester spécifiquement un mode de jeu
 */
function testGameModeVoting(mode, voteCount = 20) {
    console.log(`🧪 TEST SPÉCIFIQUE DU MODE: ${mode}`);
    
    // Sauvegarder le mode actuel
    const originalMode = gameMode;
    
    // Changer temporairement le mode (attention: peut avoir des effets de bord)
    console.warn('⚠️ Changement temporaire de mode pour test');
    window.gameMode = mode;
    
    const result = simulateSmartVotes(voteCount, true);
    
    // Restaurer le mode original
    window.gameMode = originalMode;
    console.log('✅ Mode restauré');
    
    return result;
}

/**
 * Fonction de test rapide avec permissions
 */
function quickSmartVotes() {
    return simulateSmartVotes(10, true);
}

// Export des nouvelles fonctions
window.simulateSmartVotes = simulateSmartVotes;
window.testGameModeVoting = testGameModeVoting;
window.quickSmartVotes = quickSmartVotes;

console.log(`
🧠 SIMULATEUR INTELLIGENT CHARGÉ !

Nouvelles fonctions :
🎯 simulateSmartVotes(10)     - Votes intelligents respectant les règles
🧪 testGameModeVoting('mod1v1', 20) - Test d'un mode spécifique  
⚡ quickSmartVotes()          - Test rapide intelligent

Exemples :
> quickSmartVotes()           // Test rapide du mode actuel
> testGameModeVoting('mod1v1') // Test spécifique du mode 1v1
> simulateSmartVotes(15)      // Test personnalisé
`);
</script>
</body>
</html>