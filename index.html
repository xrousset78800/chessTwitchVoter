<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Twitchess</title>
  <base href="./">
  <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU" crossorigin="anonymous">
  <link rel="stylesheet" href="css/style.css">
	  <script src="js/tmi.min.js"></script>
	  <script src="twitchToken.js"></script>
	  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

	  <script src="js/phantom.js" charset="utf-8"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"> <!-- Inclure Font Awesome -->

	  <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.1.0/chartjs-plugin-datalabels.min.js"></script>
  <link href='http://fonts.googleapis.com/css?family=Roboto+Condensed' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
</head>
<body data-team="w"> 
	<h1 data-lang="fr-FR">Twitchess</h1>
	<h1 data-lang="en-EN">Twitchess</h1>

	<!--- Begin Example HTML ------------------------------------------------------>
	<div id="board_wrapper">
		<canvas id="primary_canvas" width="630" height="630" ></canvas>
		<canvas id="drawing_canvas"  width="630" height="630" ></canvas>
		<div id="myBoard" style="width: 630px;"></div>
		<ul class="c-rainbow">
			 <li class="c-rainbow__layer c-rainbow__layer--white"></li>
			 <li class="c-rainbow__layer c-rainbow__layer--orange"></li>
			 <li class="c-rainbow__layer c-rainbow__layer--red"></li>
			 <li class="c-rainbow__layer c-rainbow__layer--violet"></li>
			 <li class="c-rainbow__layer c-rainbow__layer--blue"></li>
			 <li class="c-rainbow__layer c-rainbow__layer--green"></li>
			 <li class="c-rainbow__layer c-rainbow__layer--yellow"></li>
		</ul>
	</div>

	<!--- End Example HTML -------------------------------------------------------->
	<div class="bloc-available">
		<div class="available">
			<ul id="availableList">
				<ul id="availableListP">
				</ul>
				<ul id="availableListB">
				</ul>
				<ul id="availableListN">
				</ul>
				<ul id="availableListR">
				</ul>
				<ul id="availableListQ">
				</ul>
				<ul id="availableListK">
				</ul>
			</ul>
		</div>
	</div>
	<div class="poll prefixed styled">
		<ol>

		</ol>
	</div>

	<div class="votes">
		<!--h5 style="position: absolute;">(ex: e5, Qxa3)</h5-->
		<h3 data-lang="fr-FR" data-team="w">Trait aux blancs</h3>
		<h3 data-lang="en-EN" data-team="w">Whites to play</h3>
		<h3 data-lang="fr-FR" data-team="b">Trait aux noirs</h3>
		<h3 data-lang="en-EN" data-team="b">Blacks to play</h3>
		<h4 data-lang="en-EN" class="status"></h4>
		<ol class="prefixed styled"></ol>
		<div id="chart"></div>
		<div class="chart-container">
	  	<canvas id="chartPoll" width="600" height="150"></canvas>
		</div>
	</div>
	<div id="probleminfo">
		<div>
			<span>Ouverture : </span>
			<span data-opening-tags></span>
		</div>
		<div>
			<span>Tags : </span>
			<span data-tags></span>
		</div>		
		<div>
			<span>Solution : </span>
			<b><p data-solution></p></b>
		</div>
		<div>
			<span>Nb de coups : </span>
			<h2 data-length></h2>
		</div>					
		<span data-attempt="0"></span>
		<p style="display: none;" data-omgSolution></p>
	</div>
	<div id="countdown" class="countdown">
	  <svg viewBox="-50 -50 100 100" stroke-width="10">
		<circle r="20"></circle>
		<circle r="20" pathLength="1"></circle>
	  </svg>
	</div>

    <form id="configForm">
    	<span id="openFormButton2" style="position: absolute;right: 10px;top: 10px;cursor: pointer;"><i class="fas fa-cog"></i></span>
    			<label for="defaultChannel">Enter twitch channel</label>
	        <input type="text" id="defaultChannel" name="defaultChannel" >
	        <label for="probMode">Jouer en mode YOLO (sandbox)</label><i class="fas fa-users"></i><i class="fas fa-users"></i><i class="fas fa-users"></i>
	        <input type="radio" id="yoloMode" name="gameMode" value="normal">
	        <br>
	        <label for="probMode">Jouer en mode problèmes (ok but fix vote/reload issues)</label><i class="fas fa-cogs"></i>
	        <input type="radio" id="probMode" name="gameMode" value="probMode">
	        <div data-game-mode="probMode">
		        <fieldset class="theme-filter-section">
					    <legend>Filtrage par thèmes</legend>
					    
					    <div class="filter-controls">
					        <button type="button" class="btn btn-secondary" onclick="selectAllThemes()">
					            Tout sélectionner
					        </button>
					        <button type="button" class="btn btn-danger" onclick="clearThemeFilter()">
					            Effacer la sélection
					        </button>
					    </div>
					    
					    <div class="problem-count" id="problemCount">
					        <span id="availableProblems">-</span>
					    </div>
					    
					    <div class="theme-list" id="themeList">
					        <!-- Les thèmes seront générés dynamiquement -->
					    </div>
					    
					    <div class="selected-themes" id="selectedThemes" style="display: none;">
					        <div id="selectedThemesTags"></div>
					    </div>
						</fieldset>
					</div>
	        <br>
	    		<label for="mod1vViewers">Seul contre tous (wip)</label><i class="fas fa-user"></i><i class="fas fa-users"></i>
	        <input type="radio" id="mod1vViewers" name="gameMode" value="mod1vViewers">
	        <div data-game-mode="mod1vViewers">
		        <label for="mod1vViewersPlayer">Pseudo du joueur</label>
		        <input type="text" id="mod1vViewersPlayer" name="mod1vViewersPlayer" >
	    		</div>
	    		<br>
	    		<label for="mod1v1">Un contre un (ok?)</label><i class="fas fa-user"></i><i class="fas fa-user"></i>
	        <input type="radio" id="mod1v1" name="gameMode" value="mod1v1">
	        <div data-game-mode="mod1v1">
		        <label for="oneVsOneModeList0">Pseudo du Joueur1</label><input type="text" id="oneVsOneModeList0" name="oneVsOneModeList0">
		        <label for="oneVsOneModeList1">Pseudo du Joueur2</label><input type="text" id="oneVsOneModeList1" name="oneVsOneModeList1">
		      </div>
		      <br>
	    		<label for="modStreamerChatvStreamerChat">Chat contre Chat (ok?)</label><i class="fas fa-users"></i><i class="fas fa-users"></i>
	        <input type="radio" id="modStreamerChatvStreamerChat" name="gameMode" value="modStreamerChatvStreamerChat">
	        <div data-game-mode="modStreamerChatvStreamerChat">
		        <label for="streamerChatvStreamerChat0">Pseudo du Streamer1</label><input type="text" id="streamerChatvStreamerChat0" name="streamerChatvStreamerChat0">
		        <label for="streamerChatvStreamerChat1">Pseudo du Streamer2</label><input type="text" id="streamerChatvStreamerChat1" name="streamerChatvStreamerChat1">
		      </div>
	        <label for="modViewersvViewers">Tous contre tous (id pair/impair)(ok but cringe)</label><i class="fas fa-users"></i><i class="fas fa-users"></i>
	        <input type="radio" id="modViewersvViewers" name="gameMode" value="modViewersvViewers">


    		<fieldset>
	    		<legend>Mode Vote !</legend> 
	        <label for="timerMode">Activer le mode vote</label><i class="fas fa-clock"></i>
	        <input type="checkbox" data-mode="timerMode" id="timerMode" name="timerMode">
	        <div data-time-mode>
		        <label for="InitialvoterTimer">Temps d'un tour</label><i class="fas fa-hourglass-half"></i>
		        <input type="number" id="InitialvoterTimer" name="InitialvoterTimer" min="0"> s
		        <br>	        	
		        <label for="timerWheelAnimation">Animation de la roue </label><i class="fas fa-circle-notch"></i>
		        <input type="number" id="timerWheelAnimation" name="timerWheelAnimation" min="0"> s
		        <br>
		        <label for="limitToOneVote">Vote unique</label><i class="fas fa-ban"></i>
		        <input type="checkbox" id="limitToOneVote" name="limitToOneVote">
		        <br>
		        <label for="majorityMode">Majorité ? / (sinon tirage au sort)</label><i class="fas fa-balance-scale"></i>
		        <input type="checkbox" id="majorityMode" name="majorityMode">		        
	        </div>
        </fieldset>	        
    		<fieldset>
	    		<legend>Options de timer</legend> 
		        <label for="pauseAfterWinLose">Durée de la pause</label><i class="fas fa-hourglass-end"></i>
		        <input type="number" id="pauseAfterWinLose" name="pauseAfterWinLose" min="0"> s
		        <label for="timerMoveBot">Animation du bot</label><i class="fas fa-robot"></i>
		        <input type="number" id="timerMoveBot" name="timerMoveBot" min="0"> s
		        <br>
		        <label for="timerMoveText">Animation du coup joué</label><i class="fas fa-file-alt"></i>
		        <input type="number" id="timerMoveText" name="timerMoveText" min="0"> s
        </fieldset>
				<fieldset>
				    <legend>Restrictions d'accès</legend>
				    <label for="followMode">Mode followers uniquement</label><i class="fas fa-heart"></i>
				    <input type="checkbox" id="followMode" name="followMode">
				    <br>
				    <label for="subMode">Mode abonnés uniquement</label><i class="fas fa-crown"></i>
				    <input type="checkbox" id="subMode" name="subMode">
				    <br>
				    <small style="color: #aaa; font-size: 12px;">
				        Note: Les modérateurs, VIPs et le broadcaster peuvent toujours jouer
				    </small>
				</fieldset>
    		<fieldset>
	    		<legend>Autres options</legend> 
	        <label for="noBg">Supprimer le background (test sur OBS ?)</label><i class="fas fa-image"></i>
	        <input type="checkbox" id="noBg" name="noBg">
	        <label for="noEpilepsy">Mode anti epilepsie (supprime le switch de background)</label><i class="fas fa-image"></i>
	        <input type="checkbox" id="noEpilepsy" name="noEpilepsy">	 
        </fieldset>

        <button type="submit" class="form-btn">Sauvegarde + reload<i class="fas fa-save"></i></button>
    </form>
    <button id="openFormButton"><i class="fas fa-cog"></i></button>

	<script
	  src="https://code.jquery.com/jquery-3.7.1.min.js"
	  integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
	  crossorigin="anonymous"></script>
	<script src="js/chessboard-1.0.0.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js" integrity="sha384-s3XgLpvmHyscVpijnseAmye819Ee3yaGa8NxstkJVyA6nuDFjt59u1QvuEl/mecz" crossorigin="anonymous"></script>
	<script src="js/chessboard-arrows.js"></script>
	<script src="js/config.js"></script>
	<script src="js/client.js"></script>


	<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

	<!-- Script d'initialisation multiplayer -->
	<script>
	// Variables globales pour le multiplayer
	window.multiplayerMode = false;
	window.gameSocket = null;
	window.currentGameId = null;
	window.playerColor = null;

	// Fonction pour vérifier si Socket.io est chargé
	if (typeof io === 'undefined') {
	    console.warn('Socket.io non chargé - Mode multiplayer désactivé');
	} else {
	    console.log('Socket.io chargé avec succès');
	    
	    // Détecter si on est en mode multiplayer via l'URL
	    const urlParams = new URLSearchParams(window.location.search);
	    const gameId = urlParams.get('game');
	    const role = urlParams.get('role');
	    
	    if (gameId && role) {
	        window.multiplayerMode = true;
	        window.currentGameId = gameId;
	        window.playerColor = (role === 'host') ? 'white' : 'black';
	        
	        console.log(`🎮 Mode Multiplayer activé`);
	        console.log(`📝 Game ID: ${gameId}`);
	        console.log(`🎨 Couleur: ${playerColor}`);
	        console.log(`👤 Rôle: ${role}`);
	        
	        // Créer l'indicateur visuel
	        document.addEventListener('DOMContentLoaded', function() {
	            // Masquer le formulaire de configuration si en multiplayer
	            const configForm = document.getElementById('configForm');
	            if (configForm) {
	                configForm.style.display = 'none';
	            }
	            
	            // Ajouter un indicateur de statut multiplayer
	            const indicator = document.createElement('div');
	            indicator.id = 'multiplayerIndicator';
	            indicator.style.cssText = `
	                position: fixed;
	                top: 60px;
	                right: 10px;
	                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
	                color: white;
	                padding: 12px 20px;
	                border-radius: 8px;
	                z-index: 10000;
	                font-family: 'Segoe UI', sans-serif;
	                font-weight: 600;
	                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
	                display: flex;
	                align-items: center;
	                gap: 10px;
	            `;
	            
	            indicator.innerHTML = `
	                <span style="font-size: 20px;">🎮</span>
	                <div>
	                    <div style="font-size: 14px;">Mode Multiplayer</div>
	                    <div style="font-size: 12px; opacity: 0.9;">
	                        ${playerColor === 'white' ? '♔ Blancs' : '♚ Noirs'} | Code: ${gameId}
	                    </div>
	                </div>
	                <div id="connectionStatus" style="width: 10px; height: 10px; background: yellow; border-radius: 50%; margin-left: 10px;" title="Connexion..."></div>
	            `;
	            
	            document.body.appendChild(indicator);
	            
	            // Ajuster l'orientation du plateau selon la couleur
	            if (typeof defaultConfig !== 'undefined' && playerColor === 'black') {
	                defaultConfig.orientation = 'black';
	                console.log('🔄 Orientation du plateau ajustée pour les noirs');
	            }
	            
	            // Initialiser la connexion Socket.io
	            initMultiplayerConnection();
	        });
	    }
	}

	// Fonction d'initialisation de la connexion multiplayer
	function initMultiplayerConnection() {
	    if (!window.multiplayerMode) return;
	    
	    console.log('🔌 Tentative de connexion au serveur...');
	    
	    // Connexion au serveur
	    // Si le serveur est sur la même machine, io() suffit
	    // Sinon, spécifiez l'URL : io('http://votre-serveur.com:3000')
	    window.gameSocket = io();
	    
	    window.gameSocket.on('connect', () => {
	        console.log('✅ Connecté au serveur multiplayer');
	        
	        // Mettre à jour l'indicateur de connexion
	        const statusDot = document.getElementById('connectionStatus');
	        if (statusDot) {
	            statusDot.style.background = '#4CAF50';
	            statusDot.title = 'Connecté';
	        }
	        
	        // Rejoindre la partie
	        window.gameSocket.emit('reconnectGame', { 
	            gameId: window.currentGameId, 
	            role: window.playerColor 
	        });
	    });
	    
	    window.gameSocket.on('disconnect', () => {
	        console.log('❌ Déconnecté du serveur');
	        
	        // Mettre à jour l'indicateur
	        const statusDot = document.getElementById('connectionStatus');
	        if (statusDot) {
	            statusDot.style.background = '#f44336';
	            statusDot.title = 'Déconnecté';
	        }
	    });
	    
	    // Écouter les votes du partenaire
	    window.gameSocket.on('partnerVotes', (votes) => {
	        console.log('📊 Votes reçus du partenaire:', votes);
	        
	        // Vérifier si c'est le tour de l'adversaire
	        if (typeof chess !== 'undefined' && chess.turn() !== window.playerColor[0]) {
	            displayPartnerVotes(votes);
	        }
	    });
	    
	    // Synchroniser les mouvements
	    window.gameSocket.on('movePlayed', (data) => {
	        console.log('♟️ Coup joué:', data);
	        
	        if (data.player !== window.playerColor) {
	            // Le partenaire a joué, appliquer le coup
	            if (typeof chess !== 'undefined' && typeof board !== 'undefined') {
	                chess.move(data.move);
	                board.position(chess.fen());
	                
	                if (typeof refreshBoard === 'function') {
	                    refreshBoard(chess);
	                }
	            }
	        }
	    });
	    
	    // Notification quand les deux joueurs sont connectés
	    window.gameSocket.on('gameReady', (data) => {
	        console.log('🎯 Partie prête !', data);
	        
	        // Afficher une notification
	        const notification = document.createElement('div');
	        notification.style.cssText = `
	            position: fixed;
	            top: 80px;
	            right: 10px;
	            background: #4CAF50;
	            color: white;
	            padding: 15px 25px;
	            border-radius: 8px;
	            z-index: 10001;
	            animation: slideIn 0.3s ease;
	        `;
	        notification.innerHTML = `
	            ✅ Les deux joueurs sont connectés !<br>
	            ⚪ ${data.players.white} vs ⚫ ${data.players.black}
	        `;
	        document.body.appendChild(notification);
	        
	        setTimeout(() => {
	            notification.remove();
	        }, 5000);
	    });
	}

	// Fonction pour afficher les votes du partenaire
	function displayPartnerVotes(votes) {
	    console.log('Affichage des votes du partenaire...');
	    
	    // Créer ou mettre à jour une zone d'affichage des votes
	    let votesDisplay = document.getElementById('partnerVotesDisplay');
	    
	    if (!votesDisplay) {
	        votesDisplay = document.createElement('div');
	        votesDisplay.id = 'partnerVotesDisplay';
	        votesDisplay.style.cssText = `
	            position: fixed;
	            bottom: 20px;
	            right: 20px;
	            background: rgba(0, 0, 0, 0.8);
	            color: white;
	            padding: 15px;
	            border-radius: 8px;
	            max-width: 300px;
	            z-index: 1000;
	        `;
	        document.body.appendChild(votesDisplay);
	    }
	    
	    // Compter les votes par coup
	    const voteCounts = {};
	    votes.forEach(vote => {
	        voteCounts[vote.move] = (voteCounts[vote.move] || 0) + 1;
	    });
	    
	    // Trier par nombre de votes
	    const sortedVotes = Object.entries(voteCounts)
	        .sort((a, b) => b[1] - a[1])
	        .slice(0, 5); // Top 5
	    
	    // Afficher
	    votesDisplay.innerHTML = `
	        <div style="font-weight: bold; margin-bottom: 10px;">
	            📊 Votes du chat adverse :
	        </div>
	        ${sortedVotes.map(([move, count]) => `
	            <div style="margin: 5px 0;">
	                ${move}: ${count} vote${count > 1 ? 's' : ''}
	            </div>
	        `).join('')}
	    `;
	}

	// Fonction helper pour émettre un mouvement en multiplayer
	window.emitMove = function(move) {
	    if (window.multiplayerMode && window.gameSocket) {
	        window.gameSocket.emit('moveSelected', {
	            gameId: window.currentGameId,
	            player: window.playerColor,
	            move: move
	        });
	    }
	};

	// Animation CSS pour les notifications
	const style = document.createElement('style');
	style.textContent = `
	    @keyframes slideIn {
	        from {
	            transform: translateX(100%);
	            opacity: 0;
	        }
	        to {
	            transform: translateX(0);
	            opacity: 1;
	        }
	    }
	`;
	document.head.appendChild(style);

	console.log('✅ Script multiplayer initialisé');
	</script>



	<script src="js/chessVoterApp.js"></script>
</body>
</html>